<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('http://yoursite.com').hostname,
    root: '/',
    scheme: 'Pisces',
    version: '7.6.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="“昔之得一者：天一以清，地得一以宁，神得一以灵，谷得一以盈，侯王得一以为天下正，其至也，谓：天毋已清将恐裂，地毋已宁将恐发；神毋已灵将恐歇，故毋已盈将恐竭，侯王毋已贵以高将恐蹶。故必贵而以贱为本，必高矣而以下为基。夫是以侯王自谓孤、寡、不榖。此其贱之本与，非也？故致数与无与。是故不欲禄禄如玉，珞珞如石。”1 MaxComputeMaxCompute，前身ODPS(Open Data Process">
<meta name="keywords" content="SQL,MaxCompute,阿里大数据计算服务">
<meta property="og:type" content="article">
<meta property="og:title" content="MaxCompute:阿里大数据计算服务浅析（SQL）">
<meta property="og:url" content="http:&#x2F;&#x2F;yoursite.com&#x2F;2018&#x2F;07&#x2F;20&#x2F;MaxCompute:%E9%98%BF%E9%87%8C%E5%A4%A7%E6%95%B0%E6%8D%AE%E8%AE%A1%E7%AE%97%E6%9C%8D%E5%8A%A1%E6%B5%85%E6%9E%90%EF%BC%88SQL%EF%BC%89&#x2F;index.html">
<meta property="og:site_name" content="boat on the sky.">
<meta property="og:description" content="“昔之得一者：天一以清，地得一以宁，神得一以灵，谷得一以盈，侯王得一以为天下正，其至也，谓：天毋已清将恐裂，地毋已宁将恐发；神毋已灵将恐歇，故毋已盈将恐竭，侯王毋已贵以高将恐蹶。故必贵而以贱为本，必高矣而以下为基。夫是以侯王自谓孤、寡、不榖。此其贱之本与，非也？故致数与无与。是故不欲禄禄如玉，珞珞如石。”1 MaxComputeMaxCompute，前身ODPS(Open Data Process">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2018-07-20T13:23:00.000Z">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/2018/07/20/MaxCompute:%E9%98%BF%E9%87%8C%E5%A4%A7%E6%95%B0%E6%8D%AE%E8%AE%A1%E7%AE%97%E6%9C%8D%E5%8A%A1%E6%B5%85%E6%9E%90%EF%BC%88SQL%EF%BC%89/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>MaxCompute:阿里大数据计算服务浅析（SQL） | boat on the sky.</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">boat on the sky.</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags<span class="badge">12</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories<span class="badge">4</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives<span class="badge">7</span></a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/boatfly" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/20/MaxCompute:%E9%98%BF%E9%87%8C%E5%A4%A7%E6%95%B0%E6%8D%AE%E8%AE%A1%E7%AE%97%E6%9C%8D%E5%8A%A1%E6%B5%85%E6%9E%90%EF%BC%88SQL%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/PlateauSong.jpeg">
      <meta itemprop="name" content="Plateau Song">
      <meta itemprop="description" content="write about some blockchain,go and microservice articles!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="boat on the sky.">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          MaxCompute:阿里大数据计算服务浅析（SQL）
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-07-20 21:23:00" itemprop="dateCreated datePublished" datetime="2018-07-20T21:23:00+08:00">2018-07-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/BigData/" itemprop="url" rel="index">
                    <span itemprop="name">BigData</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>“昔之得一者：天一以清，地得一以宁，神得一以灵，谷得一以盈，侯王得一以为天下正，其至也，谓：天毋已清将恐裂，地毋已宁将恐发；神毋已灵将恐歇，故毋已盈将恐竭，侯王毋已贵以高将恐蹶。<br>故必贵而以贱为本，必高矣而以下为基。<br>夫是以侯王自谓孤、寡、不榖。<br>此其贱之本与，非也？<br>故致数与无与。<br>是故不欲禄禄如玉，珞珞如石。”<sup><a href="#myfootnote1">1</a></sup></p>
<h3 id="MaxCompute"><a href="#MaxCompute" class="headerlink" title="MaxCompute"></a>MaxCompute</h3><p>MaxCompute，前身ODPS(Open Data Processing Service)，是阿里巴巴通用计算平台提供的一种快速、完全托管的 GB/TB/PB 级数据仓库解决方案，MaxCompute 向用户提供了完善的数据导入方案以及多种经典的分布式计算模型，能够更快速的解决用户海量数据计算问题。</p>
<p>本篇参考maxcompute官方文档而来，有兴趣可以<a href="https://help.aliyun.com/document_detail/27860.html?spm=a2c4g.11174283.6.612.xLm7lG" target="_blank" rel="noopener">前往</a>。</p>
<h3 id="SQL"><a href="#SQL" class="headerlink" title="SQL"></a>SQL</h3><p>maxcompute sql可以看作是标准sql的子集，但是也有<a href="https://help.aliyun.com/document_detail/54051.html?spm=a2c4g.11186623.2.4.yUIpU0" target="_blank" rel="noopener">差异</a>。</p>
<h4 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h4><table>
<thead>
<tr>
<th align="left">操作符</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">like</td>
<td align="left"><code>通配符</code><br>如果A或B为NULL，返回NULL，A为字符串，B为要匹配的模式， 如果匹配，返回TRUE，否则返回FALSE。’%’匹配任意多个字符，’_‘匹配单个字符。要匹配’%’或’_’需要用转义符表示’%’，’_’。</td>
</tr>
<tr>
<td align="left">rlike</td>
<td align="left"><code>正则</code>；A是字符串，B是字符串常量正则表达式； 如果匹配成功，返回TRUE，否则返回FALSE； 如果B为空串会报错退出；如果A或B为NULL，返回NULL；</td>
</tr>
<tr>
<td align="left">A &amp; B</td>
<td align="left">返回A与B进行按位与的结果。例如：1&amp;2返回0，1&amp;3返回1，NULL与任何值按位与都为NULL。 A和B必须为Bigint类型。</td>
</tr>
<tr>
<td align="left">A | B</td>
<td align="left">返回A与B进行按位或的结果。例如：1 |2返回3，1 |3返回3，NULL与任何值按位或都为NULL。 A和B 必须为Bigint类型。</td>
</tr>
<tr>
<td align="left"><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> user_name <span class="keyword">like</span> <span class="string">'%goshine_user%'</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> user_name <span class="keyword">rlike</span> <span class="string">'^goshine_user*'</span>;</span></pre></td></tr></table></figure></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">关于正则表达式的笔记请参考我的另一篇笔记<a href="https://www.jianshu.com/p/0cd280dbddef" target="_blank" rel="noopener">《从java(python)到scala的n种记忆》</a></td>
<td align="left"></td>
</tr>
</tbody></table>
<p><strong>由于 double 值存在一定的精度差，因此，不建议您直接使用等号对两个 double 类型的数据进行比较。您可以使用两个 double 类型相减，然后取绝对值的方式进行判断。当绝对值足够小时，认为两个 double 数值相等。</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">abs(0.9999999999 - 1.0000000000) &lt; 0.000000001</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 0.9999999999和1.0000000000为10位精度，而0.000000001为9位精度。</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 此时可以认为0.9999999999和1.0000000000相等。</span></span></pre></td></tr></table></figure>

<h4 id="类型转换"><a href="#类型转换" class="headerlink" title="类型转换"></a>类型转换</h4><p>分为隐式类型转换和显示类型转换，显示使用cast：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">case</span>(user_id <span class="keyword">as</span> <span class="keyword">double</span>) <span class="keyword">as</span> new_id <span class="keyword">from</span> <span class="keyword">user</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">cast</span>(<span class="string">'2015-10-01 00:00:00'</span> <span class="keyword">as</span> datetime) <span class="keyword">as</span> new_date <span class="keyword">from</span> <span class="keyword">user</span>;</span></pre></td></tr></table></figure>
<ul>
<li>date和string类型之间的转换<br>严格按照格式形如：<code>yyyy-mm-dd hh:mi:ss</code>，除正常的转换之外，妖孽一点的可以用TO_DATE:<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">to_date('阿里巴巴2010-12*03', '阿里巴巴yyyy-mm*dd') = 2010-12-03 00:00:00</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">to_date('20080718', 'yyyymmdd') = 2008-07-18 00:00:00</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">to_date('200807182030','yyyymmddhhmi')=2008-07-18 20:30:00</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">to_date('2008718', 'yyyymmdd')</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 格式不符合，引发异常</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">to_date('阿里巴巴2010-12*3', '阿里巴巴yyyy-mm*dd')</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 格式不符合，引发异常</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">to_date('2010-24-01', 'yyyy')</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 格式不符合，引发异常</span></span></pre></td></tr></table></figure>
同时maxcompute提供了一些列其他的内建函数（DATEADD、DATEDIFF、DATEPART、 DATETRUNC、FROM_UNIXTIME、GETDATE、ISDATE、LASTDAY等），一定会经常用到，可以去<a href="https://help.aliyun.com/document_detail/48974.html?spm=a2c4g.11186623.2.10.YDSepC" target="_blank" rel="noopener">看看</a>。</li>
</ul>
<h4 id="DDL语句"><a href="#DDL语句" class="headerlink" title="DDL语句"></a>DDL语句</h4><ul>
<li>创建表<br>要加<code>if not exists</code>!<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> [<span class="keyword">EXTERNAL</span>] <span class="keyword">TABLE</span> [<span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] table_name</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">[(col_name data_type [<span class="keyword">COMMENT</span> col_comment], ...)]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">[<span class="keyword">COMMENT</span> table_comment]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">[PARTITIONED <span class="keyword">BY</span> (col_name data_type [<span class="keyword">COMMENT</span> col_comment], ...)]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">[<span class="keyword">STORED</span> <span class="keyword">BY</span> StorageHandler] <span class="comment">-- 仅限外部表</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">[<span class="keyword">WITH</span> SERDEPROPERTIES (Options)] <span class="comment">-- 仅限外部表</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">[LOCATION OSSLocation];<span class="comment">-- 仅限外部表</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">[LIFECYCLE days]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">[AS select_statement]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> [<span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] table_name</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">LIKE</span> existing_table_name</span></pre></td></tr></table></figure>
一张表最多允许60000个分区，单表的分区层次不能超过6级。<br>lifecycle表的生命周期，单位：天。create table like语句不会复制源表的生命周期属性。<br>创建一张表：<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> sale_detail(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"> shop_name     <span class="keyword">string</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"> customer_id   <span class="keyword">string</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"> total_price   <span class="keyword">double</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"> partitioned <span class="keyword">by</span> (sale_date <span class="keyword">string</span>,region <span class="keyword">string</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"> <span class="comment">-- 创建一张分区表 sale_detail</span></span></pre></td></tr></table></figure>
复制表，方式一：建表的同时将数据复制到新表<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> sale_detail_ctas1 <span class="keyword">as</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">select</span> * <span class="keyword">from</span> sale_detail;</span></pre></td></tr></table></figure></li>
</ul>
<p><strong>创建的表不会复制分区属性，只会把源表的分区列作为目标表的一般列处理，即sale_detail_ctas1是一个含有5列的非分区表。</strong><br>复制表，方式二：指定列的名字</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> sale_detail_ctas2 <span class="keyword">as</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">select</span> shop_name,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">            customer_id,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">            total_price,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">            <span class="string">'2013'</span> <span class="keyword">as</span> sale_date,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">            <span class="string">'China'</span> <span class="keyword">as</span> region</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">from</span> sale_detail;</span></pre></td></tr></table></figure>
<p>复制表，方式三：不指定列的名字</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> sale_detail_ctas3 <span class="keyword">as</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">select</span> shop_name,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">            customer_id,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">            total_price,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">            <span class="string">'2013'</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">            <span class="string">'China'</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">from</span> sale_detail;</span></pre></td></tr></table></figure>
<p><strong>创建的表sale_detail_ctas3的第四、五列会是类似<code>_c5</code>，<code>_c6</code></strong><br>复制表，方式三：表和目标表具有相同的表结构</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> sale_detail_like <span class="keyword">like</span> sale_detail;</span></pre></td></tr></table></figure>
<p><strong><em>注意：貌似，建表的时候只是指定了列的类型，并没有指定列的长度。</em></strong></p>
<ul>
<li>查看表信息<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">desc &lt;table_name&gt;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">desc extended &lt;table_name&gt;;--查看外部表信息</span></pre></td></tr></table></figure></li>
<li>删除表<br>要加<code>if exists</code>!<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> [<span class="keyword">IF</span> <span class="keyword">EXISTS</span>] table_name;</span></pre></td></tr></table></figure></li>
<li>重命名表<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name <span class="keyword">RENAME</span> <span class="keyword">TO</span> new_table_name;</span></pre></td></tr></table></figure>
^o^,逻辑有<code>if exists</code>的判断，但是形式上却没有嵌入的语法。</li>
<li>修改表的注释<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name <span class="keyword">SET</span> <span class="keyword">COMMENT</span> <span class="string">'tbl comment'</span>;</span></pre></td></tr></table></figure></li>
<li>修改表的修改时间<br>MaxCompute SQL提供<code>touch</code>操作用来修改表的<strong>LastDataModifiedTime</strong>。效果会将表的LastDataModifiedTime修改为<strong>当前时间</strong>。此操作会改变表的LastDataModifiedTime的值，此时，MaxCompute会认为表的数据有变动，<strong>生命周期的计算会重新开始</strong>。<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name TOUCH;</span></pre></td></tr></table></figure></li>
<li>清空非分区表里的数据<br>将指定的非分区表中的数据清空，该命令不支持分区表。对于分区表，可以用<code>ALTER TABLE table_name DROP PARTITION</code>的方式将分区里的数据清除。<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">TRUNCATE</span> <span class="keyword">TABLE</span> table_name;</span></pre></td></tr></table></figure></li>
<li>修改表的生命周期<br>MaxCompute提供数据生命周期管理功能，以方便您释放存储空间，简化回收数据的流程。<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name <span class="keyword">SET</span> lifecycle <span class="keyword">days</span>;</span></pre></td></tr></table></figure>
如：<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> test_lifecycle(<span class="keyword">key</span> <span class="keyword">string</span>) lifecycle <span class="number">100</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 新建test_lifecycle表，生命周期为100天。</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> test_lifecycle <span class="keyword">set</span> lifecycle <span class="number">50</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 修改test_lifecycle表，将生命周期设为50天。</span></span></pre></td></tr></table></figure></li>
<li>禁止生命周期<br>某些情况下，部分特定的分区不希望被生命周期功能自动回收掉，比如一个月的月初或双十一期间的数据，此时您可以禁止该分区被生命周期功能回收。<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name [partition_spec] <span class="keyword">ENABLE</span>|<span class="keyword">DISABLE</span> LIFECYCLE;</span></pre></td></tr></table></figure>
如：<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> trans <span class="keyword">PARTITION</span>(dt=<span class="string">'20141111'</span>) <span class="keyword">DISABLE</span> LIFECYCLE;</span></pre></td></tr></table></figure></li>
<li>创建视图<br>要加<code>if not exists</code>!</li>
</ul>
<p><strong>视图没有分区（partition）的概念</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> [<span class="keyword">OR</span> <span class="keyword">REPLACE</span>] <span class="keyword">VIEW</span> [<span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] view_name</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">[(col_name [<span class="keyword">COMMENT</span> col_comment], ...)]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">[<span class="keyword">COMMENT</span> view_comment]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">[<span class="keyword">AS</span> select_statement]</span></pre></td></tr></table></figure>
<blockquote>
<p>1.视图只能包含一个有效的select语句。<br>2.不允许向视图写入数据，例如使用insert into或者insert overwrite操作视图。<br>3.当建好视图后，如果视图的引用表发生了变更，有可能导致视图无法访问，例如删除被引用表。您需要自己维护引用表及视图之间的对应关系。</p>
</blockquote>
<p>如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> sale_detail_view</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">(store_name, customer_id, price, sale_date, region)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">comment</span> <span class="string">'a view for table sale_detail'</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">as</span> <span class="keyword">select</span> * <span class="keyword">from</span> sale_detail;</span></pre></td></tr></table></figure>

<ul>
<li>删除视图<br>要加<code>if exists</code>!<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">VIEW</span> [<span class="keyword">IF</span> <span class="keyword">EXISTS</span>] view_name;</span></pre></td></tr></table></figure></li>
<li>重命名视图<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">VIEW</span> view_name <span class="keyword">RENAME</span> <span class="keyword">TO</span> new_view_name;</span></pre></td></tr></table></figure>
如：<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> sale_detail_view</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">        (store_name, customer_id, price, sale_date, region)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">comment</span> <span class="string">'a view for table sale_detail'</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">as</span> <span class="keyword">select</span> * <span class="keyword">from</span> sale_detail;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">view</span> sale_detail_view <span class="keyword">rename</span> <span class="keyword">to</span> market;</span></pre></td></tr></table></figure></li>
<li>添加分区<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> TABLE_NAME <span class="keyword">ADD</span> [<span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] <span class="keyword">PARTITION</span> partition_spec</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    partition_spec:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        : (partition_col1 = partition_col_value1, partition_col2 = partiton_col_value2, ...)</span></pre></td></tr></table></figure>
<blockquote>
<p>1.仅支持新增分区，不支持新增分区字段。<br>2.目前MaxCompute单表支持的分区数量上限为6万。<br>3.对于多级分区的表，如果想添加新的分区，必须指明全部的分区值。</p>
</blockquote>
</li>
</ul>
<p>如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> sale_detail <span class="keyword">add</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> <span class="keyword">partition</span> (sale_date=<span class="string">'201312'</span>, region=<span class="string">'hangzhou'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">-- 成功添加分区，用来存储2013年12月杭州地区的销售记录。</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> sale_detail <span class="keyword">add</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> <span class="keyword">partition</span> (sale_date=<span class="string">'201312'</span>, region=<span class="string">'shanghai'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">-- 成功添加分区，用来存储2013年12月上海地区的销售记录。</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> sale_detail <span class="keyword">add</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> <span class="keyword">partition</span>(sale_date=<span class="string">'20111011'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">-- 仅指定一个分区sale_date，出错返回</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> sale_detail <span class="keyword">add</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> <span class="keyword">partition</span>(region=<span class="string">'shanghai'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">-- 仅指定一个分区region，出错返回</span></span></pre></td></tr></table></figure>

<ul>
<li>删除分区<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> TABLE_NAME <span class="keyword">DROP</span> [<span class="keyword">IF</span> <span class="keyword">EXISTS</span>] <span class="keyword">PARTITION</span> partition_spec;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">partition_spec:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        : (partition_col1 = partition_col_value1, partition_col2 = partiton_col_value2, ...)</span></pre></td></tr></table></figure>
如：<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> sale_detail <span class="keyword">drop</span> <span class="keyword">if</span> <span class="keyword">exists</span> <span class="keyword">partition</span>(sale_date=<span class="string">'201312'</span>,region=<span class="string">'hangzhou'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">-- 成功删除2013年12月杭州分区的销售。</span></span></pre></td></tr></table></figure></li>
<li>添加列<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name <span class="keyword">ADD</span> <span class="keyword">COLUMNS</span> (col_name1 type1, col_name2 type2...)</span></pre></td></tr></table></figure></li>
</ul>
<p><strong>添加的新列不支持指定顺序，默认在最后一列。</strong></p>
<ul>
<li>修改列名<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name <span class="keyword">CHANGE</span> <span class="keyword">COLUMN</span> old_col_name <span class="keyword">RENAME</span> <span class="keyword">TO</span> new_col_name;</span></pre></td></tr></table></figure></li>
<li>修改列、分区注释<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name <span class="keyword">CHANGE</span> <span class="keyword">COLUMN</span> col_name <span class="keyword">COMMENT</span> comment_string;</span></pre></td></tr></table></figure></li>
<li>同时修改列名及列注释<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name <span class="keyword">CHANGE</span> <span class="keyword">COLUMN</span> old_col_name new_col_name column_type <span class="keyword">COMMENT</span> column_comment;</span></pre></td></tr></table></figure></li>
<li>修改表、分区的修改时间<br>MaxCompute SQL提供touch操作用来修改分区的LastDataModifiedTime。效果会将分区的LastDataModifiedTime修改为当前时间。<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name TOUCH <span class="keyword">PARTITION</span>(partition_col=<span class="string">'partition_col_value'</span>, ...);</span></pre></td></tr></table></figure></li>
</ul>
<p><strong>此操作会改变表的LastDataModifiedTime的值，此时，MaxCompute会认为表或分区的数据有变动，生命周期的计算会重新开始。</strong></p>
<ul>
<li>修改分区值<br>MaxCompute SQL支持通过rename操作更改对应表的分区值。<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name <span class="keyword">PARTITION</span> (partition_col1 = partition_col_value1, partition_col2 = partiton_col_value2, ...)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">RENAME</span> <span class="keyword">TO</span> <span class="keyword">PARTITION</span> (partition_col1 = partition_col_newvalue1, partition_col2 = partiton_col_newvalue2, ...);</span></pre></td></tr></table></figure>
<h4 id="Insert操作"><a href="#Insert操作" class="headerlink" title="Insert操作"></a>Insert操作</h4></li>
<li>更新表中的数据 insert overwrite/into<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> OVERWRITE|<span class="keyword">INTO</span> <span class="keyword">TABLE</span> tablename [<span class="keyword">PARTITION</span> (partcol1=val1, partcol2=val2 ...)] [(col1,col2 ...)]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">select_statement</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> from_statement;</span></pre></td></tr></table></figure></li>
</ul>
<p><strong>场景</strong>：在MaxCompute SQL处理数据的过程中，Insert overwrite/into用于将计算的结果保存目标表中，以供下一步计算使用。<br>overwrite/into区别：Insert into会向表或表的分区中追加数据，而Insert overwrite则会在向表或分区中插入数据前清空表中的原有数据。<br>如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> sale_detail_insert <span class="keyword">like</span> sale_detail;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> sale_detail_insert <span class="keyword">add</span> <span class="keyword">partition</span>(sale_date=<span class="string">'2013'</span>, region=<span class="string">'china'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> sale_detail_insert <span class="keyword">partition</span> (sale_date=<span class="string">'2013'</span>, region=<span class="string">'china'</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">select</span> shop_name, customer_id, total_price <span class="keyword">from</span> sale_detail;</span></pre></td></tr></table></figure>
<p><strong>注意</strong>：在进行Insert更新数据操作时，源表与目标表的对应关系依赖于在select子句中列的顺序，而不是表与表之间列名的对应关系：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> sale_detail_insert <span class="keyword">partition</span> (sale_date=<span class="string">'2013'</span>, region=<span class="string">'china'</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">select</span> customer_id, shop_name, total_price <span class="keyword">from</span> sale_detail;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">-- 在创建sale_detail_insert表时，列的顺序为：</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">-- shop_name string, customer_id string, total_price bigint</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">-- 而从sale_detail向sale_detail_insert插入数据是，sale_detail的插入顺序为：</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">-- customer_id, shop_name, total_price</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">-- 此时，会将sale_detail.customer_id的数据插入sale_detail_insert.shop_name</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">-- 将sale_detail.shop_name的数据插入sale_detail_insert.customer_id</span></span></pre></td></tr></table></figure>
<p>非法语句，场景一：向某个分区插入数据时，分区列不允许出现在select列表中：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> sale_detail_insert <span class="keyword">partition</span> (sale_date=<span class="string">'2013'</span>, region=<span class="string">'china'</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">select</span> shop_name, customer_id, total_price, sale_date, region  <span class="keyword">from</span> sale_detail;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">-- 报错返回，sale_date，region 为分区列，不允许出现在静态分区的 insert 语句中。</span></span></pre></td></tr></table></figure>
<p>非法语句，场景二：partition的值只能是常量，不可以出现表达式。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> sale_detail_insert <span class="keyword">partition</span> (sale_date=<span class="keyword">datepart</span>(<span class="string">'2016-09-18 01:10:00'</span>, <span class="string">'yyyy'</span>) , region=<span class="string">'china'</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">select</span> shop_name, customer_id, total_price <span class="keyword">from</span> sale_detail;</span></pre></td></tr></table></figure>

<ul>
<li>多路输出 Multi insert<br>MaxCompute SQL支持在一个语句中插入不同的结果表或者分区。<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">FROM from_statement</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">INSERT</span> OVERWRITE | <span class="keyword">INTO</span> <span class="keyword">TABLE</span> tablename1 [<span class="keyword">PARTITION</span> (partcol1=val1, partcol2=val2 ...)]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">            select_statement1 [<span class="keyword">FROM</span> from_statement]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        [<span class="keyword">INSERT</span> OVERWRITE | <span class="keyword">INTO</span> <span class="keyword">TABLE</span> tablename2 [<span class="keyword">PARTITION</span> (partcol1=val3, partcol2=val4 ...)]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">            select_statement2 [<span class="keyword">FROM</span> from_statement]]</span></pre></td></tr></table></figure></li>
</ul>
<p><strong>注意</strong>：对于同一张分区表的不同分区，不能同时有Insert overwrite和Insert into操作，否则报错返回。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> sale_detail_multi <span class="keyword">like</span> sale_detail;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">from sale_detail</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">insert</span> overwrite <span class="keyword">table</span> sale_detail_multi <span class="keyword">partition</span> (sale_date=<span class="string">'2010'</span>, region=<span class="string">'china'</span> )</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">select</span> shop_name, customer_id, total_price <span class="keyword">where</span> .....</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">insert</span> overwrite <span class="keyword">table</span> sale_detail_multi <span class="keyword">partition</span> (sale_date=<span class="string">'2011'</span>, region=<span class="string">'china'</span> )</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">select</span> shop_name, customer_id, total_price <span class="keyword">where</span> .....;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">-- 成功返回，将 sale_detail 的数据插入到 sales 里的 2010 年及 2011 年中国大区的销售记录中。</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">from sale_detail</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">insert</span> overwrite <span class="keyword">table</span> sale_detail_multi <span class="keyword">partition</span> (sale_date=<span class="string">'2010'</span>, region=<span class="string">'china'</span> )</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">select</span> shop_name, customer_id, total_price</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">insert</span> overwrite <span class="keyword">table</span> sale_detail_multi <span class="keyword">partition</span> (sale_date=<span class="string">'2010'</span>, region=<span class="string">'china'</span> )</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">select</span> shop_name, customer_id, total_price;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">-- 出错返回，同一分区出现多次。</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">from sale_detail</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">insert</span> overwrite <span class="keyword">table</span> sale_detail_multi <span class="keyword">partition</span> (sale_date=<span class="string">'2010'</span>, region=<span class="string">'china'</span> )</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">select</span> shop_name, customer_id, total_price</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">table</span> sale_detail_multi <span class="keyword">partition</span> (sale_date=<span class="string">'2011'</span>, region=<span class="string">'china'</span> )</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">select</span> shop_name, customer_id, total_price;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">-- 出错返回，同一张表的不同分区，不能同时有 insert overwrite 和 insert into 操作。</span></span></pre></td></tr></table></figure>
<ul>
<li>输出到动态分区 Dynamic partition<br>在Insert overwrite到一张分区表时，可以在语句中指定分区的值。也可以用另外一种更加灵活的方式，在分区中指定一个分区列名，但不给出值。相应地，在select子句中的对应列来提供分区的值。<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> tablename <span class="keyword">partition</span> (partcol1, partcol2 ...) select_statement <span class="keyword">from</span> from_statement;</span></pre></td></tr></table></figure>
如：<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> total_revenues (revenue <span class="built_in">bigint</span>) partitioned <span class="keyword">by</span> (region <span class="keyword">string</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">insert</span> overwrite <span class="keyword">table</span> total_revenues <span class="keyword">partition</span>(region)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">select</span> total_price <span class="keyword">as</span> revenue, region</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">from</span> sale_detail;</span></pre></td></tr></table></figure>
在SQL运行之前，是不知道会产生哪些分区的，只有在select运行结束后，才能由region字段产生的值确定会产生哪些分区，这也是叫做动态分区的原因。</li>
</ul>
<p>“一个顺序”需要谨记：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> sale_detail_dypart <span class="keyword">like</span> sale_detail;<span class="comment">--创建示例目标表</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> sale_detail_dypart <span class="keyword">partition</span> (sale_date, region)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">select</span> shop_name,customer_id,total_price,sale_date,region <span class="keyword">from</span> sale_detail;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">-- 成功返回;</span></span></pre></td></tr></table></figure>
<p>此时sale_detail表中，sale_date的值决定目标表的sale_date分区值，region的值决定目标表的region分区值。约定俗成select的最后的字段为partition的字段，双发的值只与其顺序有关！</p>
<ul>
<li>Values<br>通常在业务测试阶段，需要给一个小数据表准备些基本数据，您可以通过INSERT … VALUES的方法快速对测试表写入一些测试数据。<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span>  <span class="keyword">INTO</span>  <span class="keyword">TABLE</span>  tablename [<span class="keyword">PARTITION</span> (partcol1=val1, partcol2=val2 ...)][co1name1,colname2...] <span class="keyword">VALUES</span> (col1_value,col2_value,...)[,(col1_value,col2_value,...),...]</span></pre></td></tr></table></figure>
场景一，插入整行数据：<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> srcp;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> srcp (<span class="keyword">key</span> <span class="keyword">string</span> ,<span class="keyword">value</span> <span class="built_in">bigint</span>) partitioned <span class="keyword">by</span> (p <span class="keyword">string</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">table</span> srcp <span class="keyword">partition</span> (p=<span class="string">'abc'</span>) <span class="keyword">values</span> (<span class="string">'a'</span>,<span class="number">1</span>),(<span class="string">'b'</span>,<span class="number">2</span>),(<span class="string">'c'</span>,<span class="number">3</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="comment">--</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">+<span class="comment">-----+------------+---+</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">| key | value      | p |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">+<span class="comment">-----+------------+---+</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">| a   | 1          | abc |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">| b   | 2          | abc |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">| c   | 3          | abc |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">+<span class="comment">-----+------------+---+</span></span></pre></td></tr></table></figure>

</li>
</ul>
<p>场景二，插入部分列：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> srcp;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> srcp (<span class="keyword">key</span> <span class="keyword">string</span> ,<span class="keyword">value</span> <span class="built_in">bigint</span>) partitioned <span class="keyword">by</span> (p <span class="keyword">string</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">table</span> srcp <span class="keyword">partition</span> (p)(<span class="keyword">key</span>,p) <span class="keyword">values</span> (<span class="string">'d'</span>,<span class="string">'20170101'</span>),(<span class="string">'e'</span>,<span class="string">'20170101'</span>),(<span class="string">'f'</span>,<span class="string">'20170101'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="comment">--</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">+<span class="comment">-----+------------+---+</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">| key | value      | p |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">+<span class="comment">-----+------------+---+</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">| d   | NULL       | 20170101 |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">| e   | NULL       | 20170101 |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">| f   | NULL       | 20170101 |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">+<span class="comment">-----+------------+---+</span></span></pre></td></tr></table></figure>
<p>对于在values中没有制定的列，可以看到取缺省值为NULL。插入列表功能不一定和values一起用，对于Insert into…select…，同样可以使用。</p>
<p>Insert…values有一个限制：values必须是常量，但是有时候希望在插入的数据中进行一些简单的运算，此时可以使用MaxCompute的values table功能，详情见场景三。</p>
<p>场景三，动态插入：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> srcp;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> srcp (<span class="keyword">key</span> <span class="keyword">string</span> ,<span class="keyword">value</span> <span class="built_in">bigint</span>) partitioned <span class="keyword">by</span> (p <span class="keyword">string</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">table</span> srcp <span class="keyword">partition</span> (p) <span class="keyword">select</span> <span class="keyword">concat</span>(a,b), <span class="keyword">length</span>(a)+<span class="keyword">length</span>(b),<span class="string">'20170102'</span> <span class="keyword">from</span>  <span class="keyword">values</span> (<span class="string">'d'</span>,<span class="number">4</span>),(<span class="string">'e'</span>,<span class="number">5</span>),(<span class="string">'f'</span>,<span class="number">6</span>) t(a,b);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="comment">--</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">+<span class="comment">-----+------------+---+</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">| key | value      | p |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">+<span class="comment">-----+------------+---+</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">| d4  | 2          | 20170102 |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">| e5  | 2          | 20170102 |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">| f6  | 2          | 20170102 |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">+<span class="comment">-----+------------+---+</span></span></pre></td></tr></table></figure>
<p>其中的values (…), (…) t (a, b)，相当于定义了一个名为t，列为a，b的表，类型为（a string，b bigint），其中的类型从values列表中推导。这样在不准备任何物理表的时候，可以模拟一个有任意数据的，多行的表，并进行任意运算。</p>
<h4 id="Select操作"><a href="#Select操作" class="headerlink" title="Select操作"></a>Select操作</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> [<span class="keyword">ALL</span> | <span class="keyword">DISTINCT</span>] select_expr, select_expr, ...</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">FROM</span> table_reference</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        [<span class="keyword">WHERE</span> where_condition]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        [<span class="keyword">GROUP</span> <span class="keyword">BY</span> col_list]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        [<span class="keyword">ORDER</span> <span class="keyword">BY</span> order_condition]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        [<span class="keyword">DISTRIBUTE</span> <span class="keyword">BY</span> distribute_condition [<span class="keyword">SORT</span> <span class="keyword">BY</span> sort_condition] ]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">        [<span class="keyword">LIMIT</span> <span class="built_in">number</span>]</span></pre></td></tr></table></figure>
<p><code>设置分区条件来指定扫描的分区!</code>，当需要对分区进行全表扫描的时候，加上<code>set odps.sql.allow.fullscan=true;</code>执行的时候，set语句和sql语句一起提交执行。如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> odps.sql.allow.fullscan=<span class="literal">true</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> sale_detail;</span></pre></td></tr></table></figure>
<p>如果需要整个项目都允许全表扫描，可以通过开关自行打开或关闭(true/false)，命里如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">setproject odps.sql.allow.fullscan=true;</span></pre></td></tr></table></figure>
<p><strong>distribute by</strong>:对数据按照某几列的值做 hash 分片，必须使用 Select 的输出列别名(当没有别名时用列名，当有别名时必须用别名，否则报错！)。<br><strong>sort by</strong>:局部排序，语句前必须加 distribute by。实际上 sort by 是对 distribute by 的结果进行局部排序。必须使用 Select 的输出列别名。<br><strong>order by</strong>:对所有数据按照某几列进行全局排序，order by 必须与 limit 共同使用。</p>
<ul>
<li><p>select 语序</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">key</span>, <span class="keyword">max</span>(<span class="keyword">value</span>) <span class="keyword">FROM</span> src t <span class="keyword">WHERE</span> <span class="keyword">value</span> &gt; <span class="number">0</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">key</span> <span class="keyword">HAVING</span> <span class="keyword">sum</span>(<span class="keyword">value</span>) &gt; <span class="number">100</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">key</span> <span class="keyword">LIMIT</span> <span class="number">100</span>;</span></pre></td></tr></table></figure>
<p>实际上的逻辑执行顺序是<code>FROM</code>-&gt;<code>WHERE</code>-&gt;<code>GROUY BY</code>-&gt;<code>HAVING</code>-&gt;<code>SELECT</code>-&gt;<code>ORDER BY</code>-&gt;<code>LIMIT</code>。<br>MaxCompute 支持以执行顺序书写查询语句，例如上面的语句可以写为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">FROM src t WHERE value &gt; 0 GROUP BY key HAVING sum(value) &gt; 100 SELECT key, max(value) ORDER BY key LIMIT 100;</span></pre></td></tr></table></figure>
</li>
<li><p>子查询</p>
</li>
</ul>
<p><strong>子查询必须有别名。</strong><br>在 from 子句中，子查询可以当作一张表来使用，与其它的表或子查询进行 Join 操作，如下所示：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> shop <span class="keyword">as</span> <span class="keyword">select</span> * <span class="keyword">from</span> sale_detail;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a.shop_name, a.customer_id, a.total_price <span class="keyword">from</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        (<span class="keyword">select</span> * <span class="keyword">from</span> shop) a <span class="keyword">join</span> sale_detail <span class="keyword">on</span> a.shop_name = sale_detail.shop_name;</span></pre></td></tr></table></figure>

<p><a name="myfootnote1">1</a>:老子《道德经》第三十九章，老子故里，中国鹿邑。</p>

    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/SQL/" rel="tag"><i class="fa fa-tag"></i> SQL</a>
              <a href="/tags/MaxCompute/" rel="tag"><i class="fa fa-tag"></i> MaxCompute</a>
              <a href="/tags/%E9%98%BF%E9%87%8C%E5%A4%A7%E6%95%B0%E6%8D%AE%E8%AE%A1%E7%AE%97%E6%9C%8D%E5%8A%A1/" rel="tag"><i class="fa fa-tag"></i> 阿里大数据计算服务</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2018/04/03/Python%E6%98%93%E7%AD%8B%E7%BB%8F-pandas/" rel="prev" title="Python易筋经-pandas">
      <i class="fa fa-chevron-left"></i> Python易筋经-pandas
    </a></div>
      <div class="post-nav-item">
    <a href="/2019/12/01/go-note/" rel="next" title="go-note 编程笔记">
      go-note 编程笔记 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#MaxCompute"><span class="nav-number">1.</span> <span class="nav-text">MaxCompute</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SQL"><span class="nav-number">2.</span> <span class="nav-text">SQL</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#运算符"><span class="nav-number">2.1.</span> <span class="nav-text">运算符</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#类型转换"><span class="nav-number">2.2.</span> <span class="nav-text">类型转换</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DDL语句"><span class="nav-number">2.3.</span> <span class="nav-text">DDL语句</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Insert操作"><span class="nav-number">2.4.</span> <span class="nav-text">Insert操作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Select操作"><span class="nav-number">2.5.</span> <span class="nav-text">Select操作</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Plateau Song"
      src="/images/PlateauSong.jpeg">
  <p class="site-author-name" itemprop="name">Plateau Song</p>
  <div class="site-description" itemprop="description">write about some blockchain,go and microservice articles!</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">7</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/boatfly" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;boatfly" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:song761212_160906@qq.com" title="E-Mail → mailto:song761212_160906@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="/15138207219" title="WeChat → 15138207219"><i class="fa fa-fw fa-wechat"></i>WeChat</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-fw fa-rss"></i>RSS</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title">
      <i class="fa fa-fw fa-link"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://www.infoq.cn/" title="https:&#x2F;&#x2F;www.infoq.cn&#x2F;" rel="noopener" target="_blank">infoQ</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://tech.meituan.com/" title="https:&#x2F;&#x2F;tech.meituan.com&#x2F;" rel="noopener" target="_blank">美团</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://jm.taobao.org/" title="http:&#x2F;&#x2F;jm.taobao.org&#x2F;" rel="noopener" target="_blank">阿里</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://ipfs.cn/" title="http:&#x2F;&#x2F;ipfs.cn&#x2F;" rel="noopener" target="_blank">IPFS</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://golang.google.cn/pkg/" title="https:&#x2F;&#x2F;golang.google.cn&#x2F;pkg&#x2F;" rel="noopener" target="_blank">GO</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://redisdoc.com/" title="http:&#x2F;&#x2F;redisdoc.com&#x2F;" rel="noopener" target="_blank">REDIS</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://spark.apache.org/docs/latest/" title="http:&#x2F;&#x2F;spark.apache.org&#x2F;docs&#x2F;latest&#x2F;" rel="noopener" target="_blank">SPARK</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.rabbitmq.com/documentation.html" title="https:&#x2F;&#x2F;www.rabbitmq.com&#x2F;documentation.html" rel="noopener" target="_blank">RabbitMQ</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.eosdata.io/" title="http:&#x2F;&#x2F;www.eosdata.io&#x2F;" rel="noopener" target="_blank">EOS</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://bitcoin.org/en/developer-documentation" title="https:&#x2F;&#x2F;bitcoin.org&#x2F;en&#x2F;developer-documentation" rel="noopener" target="_blank">BitCoin</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Plateau Song</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.6.0
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  















  

  

</body>
</html>
